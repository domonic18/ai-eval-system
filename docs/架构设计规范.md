# AI评测系统架构设计规范（更新版）

## 1. 系统概述
```mermaid
graph TD
    subgraph 表示层
        A[Web前端] --> B[Web API]
    end

    subgraph 应用层
        B --> C[任务管理服务]
        C --> D[Celery Worker]
        D --> E[OpenCompass评测引擎]
    end

    subgraph 数据层
        C --> F[(Redis)]
        C --> G[(MySQL)]
        F -. 消息队列 .-> D
        G -. 状态持久化 .-> C
    end

    subgraph 外部系统
        E --> H[模型仓库]
        E --> I[数据集存储]
    end

    style A fill:#4CAF50,color:white
    style B fill:#2196F3,color:white
    style C fill:#FF9800,color:white
    style D fill:#795548,color:white
    style E fill:#9C27B0,color:white
    style F fill:#E91E63,color:white
    style G fill:#009688,color:white
    style H fill:#607D8B,color:white
    style I fill:#607D8B,color:white
```

## 2. 核心组件

### 2.1 任务管理组件
```mermaid
graph TD
    A[TaskManager] --> B[任务队列管理]
    A --> C[状态机管理]
    A --> D[资源分配]
    B --> E[Redis队列]
    C --> F[状态持久化]
```

### 2.2 通信层组件
```mermaid
graph LR
    G[WebSocket服务] --> H[实时日志]
    G --> I[状态推送]
    H --> J[Redis PUB/SUB]
    I --> J
    J --> K[Celery Worker]
```


### 2.3 数据流设计
#### 2.3.1 任务生命周期数据流
##### 2.3.1.1 任务创建执行流程
```mermaid
sequenceDiagram
    participant F as 前端
    participant B as 后端API
    participant TM as TaskManager
    participant Q as Redis队列
    participant W as Celery Worker
    
    F->>B: POST /tasks
    B->>TM: 创建任务
    TM->>Q: LPUSH eval_tasks
    TM->>Q: HSET task:{id} status=PENDING
    TM-->>B: 返回任务ID
    B-->>F: 201 Created

    loop 任务执行
        W->>Q: BRPOP eval_tasks
        Q-->>W: 返回task_id
        W->>Q: HSET task:{id} status=RUNNING
        W->>W: 执行任务并生成日志
        W->>Q: XADD log:{id} * message "..."
        alt 执行成功
            W->>Q: HSET task:{id} status=SUCCESS
        else 执行失败
            W->>Q: HSET task:{id} status=FAILED
        end
    end
```

##### 2.3.1.2 任务完成执行流程
```mermaid
sequenceDiagram
    participant W as Celery Worker
    participant R as Redis
    participant TM as TaskManager
    participant DB as MySQL
    
    W->>R: XADD status_stream <br>task_id status=SUCCESS
    R->>TM: 通知状态变更
    TM->>DB: 持久化最终结果
    TM->>R: HSET task:{id} final_result=...
    TM->>R: EXPIRE task:{id} 3600
    TM->>R: LREM eval_tasks {id}
    
    loop 后续处理
        TM->>分析服务: 触发结果分析
        分析服务->>DB: 存储分析报告
        TM->>R: DEL task:{id}_lock
    end
```

##### 2.3.1.3 任务终止执行流程
```mermaid
sequenceDiagram
    participant F as 前端
    participant B as 后端API
    participant TM as TaskManager
    participant R as Redis
    participant W as Celery Worker
    
    F->>B: POST /tasks/{id}/terminate
    B->>TM: 终止请求
    
    alt 任务可终止
        TM->>R: HSET task:{id} status=TERMINATING
        B-->>F: 202 Accepted
        Note over W: Worker定期检查任务状态<br>(比如每1秒)
        W->>R: HGET task:{id} status
        R-->>W: TERMINATING
        W->>W: 停止任务执行
        W->>R: HSET task:{id} status=TERMINATED
    else 任务已结束
        TM-->>B: 任务已完成
        B-->>F: 409 Conflict
    end
```

##### 2.3.1.4 任务队列管理流程（混合架构方案）

```mermaid
sequenceDiagram
    participant TM as TaskManager
    participant Q as Redis队列
    participant W as Celery Worker
    participant DB as MySQL

    loop 状态监控（每10秒）
        TM->>Q: GET queue_metrics
        Q-->>TM: 返回队列长度/内存使用
        TM->>DB: 记录监控指标
    end

    loop 任务调度
        TM->>Q: EVAL调度策略脚本
        Q-->>TM: 返回待调度任务
        alt 需要入队
            TM->>Q: RPUSH eval_tasks
            TM->>DB: 记录调度日志
        end
    end

    loop 任务执行
        W->>TM: 请求任务
        TM->>Q: BRPOP eval_tasks 30
        Q-->>TM: 返回task_id
        TM->>W: 分配任务
        W->>DB: 更新状态为RUNNING
        W->>Q: HSET task:{id} worker=当前节点
        W->>W: 执行评测任务
        alt 执行成功
            W->>Q: SET status=SUCCESS
            Q->>DB: 异步持久化
        else 执行失败
            W->>TM: 上报失败
            TM->>Q: LPUSH eval_tasks
            TM->>DB: 记录重试次数
        end
    end

    loop 异常处理
        TM->>Q: 扫描超时任务
        Q-->>TM: 返回最后心跳时间
        alt 任务超时
            TM->>Q: DEL task_lock:{id}
            TM->>DB: 标记任务状态
            TM->>Q: LPUSH eval_tasks
        end
    end
```

#### 2.3.2 日志数据流
```mermaid
flowchart LR
    subgraph 日志生成端
        A[Celery Task] --> B[Redis Streams]
        A --> C[Redis Pub/Sub]
    end
    
    subgraph 日志消费端
        B --> D[日志存储]
        C --> E[实时推送]
        D --> F[历史查询]
        E --> G[WebSocket]
    end
```

##### 2.3.2.1 WebSocket建立连接
```mermaid
sequenceDiagram
    participant C as 客户端
    participant R as Router
    participant S as WebSocket服务
    participant Redis
    
    C->>R: /ws/logs/{task_id}
    R->>S: 路由到对应服务节点
    S->>Redis: XRANGE log:{task_id} - +
    Redis-->>S: 返回历史日志
    S->>C: 发送历史日志
    S->>Redis: SUBSCRIBE log:{task_id}
    
    loop 实时更新
        Redis->>S: 推送新日志
        S->>C: 转发日志消息
    end
```


##### 2.3.2.3 WebSocket关闭连接
```mermaid
sequenceDiagram
    participant C as 客户端
    participant S as WebSocket服务
    participant Redis
    
    alt 正常关闭
        C->>S: 发送关闭帧(1000)
        S->>Redis: UNSUBSCRIBE log:{task_id}
        Redis-->>S: 确认取消订阅
        S->>C: 发送关闭确认
    else 异常断开
        Note over S: 心跳检测超时（30秒）
        S->>Redis: UNSUBSCRIBE + DEL ws_session:{task_id}
    end
```

### 2.4 任务状态跟踪
```mermaid
stateDiagram-v2
    [*] --> QUEUED: 创建任务
    QUEUED --> RUNNING: Worker领取任务
    RUNNING --> SUCCESS: 执行成功
    RUNNING --> FAILED: 执行失败
    QUEUED --> TERMINATED: 直接终止
    RUNNING --> TERMINATED: 运行中终止
    SUCCESS --> [*]
    FAILED --> [*]
    TERMINATED --> [*]
```


## 3. 数据存储
### 3.1 Redis数据存储
#### 键命名规范
| 数据类型       | 键格式示例                  | 存储类型 | 说明                     |
|----------------|----------------------------|----------|--------------------------|
| 任务状态       | `task:{task_id}:status`    | String   | 存储当前任务状态         |
| 任务进度       | `task:{task_id}:progress`  | Hash     | 包含进度百分比和消息     |
| 任务队列       | `queue:eval_tasks`         | List     | 待处理任务ID列表         |
| 日志存储       | `log:{task_id}`            | Stream   | 任务执行日志流           |
| 锁机制         | `lock:{resource}`          | String   | 分布式锁                 |
| 缓存数据       | `cache:{key}`              | String   | 通用缓存数据             |

#### 任务状态数据结构示例
```python
{
    "status": "RUNNING",
    "last_update": "2024-03-10T14:30:00Z",
    "worker_node": "celery@node01"
}
```

#### 日志流消息格式
```python
{
    "timestamp": "2024-03-10T14:30:00.123Z",
    "level": "INFO",
    "message": "开始执行模型推理",
    "progress": 0.15
}
```

### 3.2 MySQL数据库表结构

#### 核心表结构概览
```sql
-- 用户表
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    is_admin BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- AI模型表
CREATE TABLE ai_models (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    provider VARCHAR(100) NOT NULL,
    model_type VARCHAR(50) NOT NULL,
    version VARCHAR(50),
    configuration JSON NOT NULL,
    is_public BOOLEAN DEFAULT TRUE,
    user_id INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 评估任务表
CREATE TABLE evaluations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    task_id VARCHAR(255) UNIQUE,
    model_name VARCHAR(255) NOT NULL,
    dataset_name VARCHAR(255) NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    results JSON,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 索引示例
CREATE INDEX idx_evaluations_status ON evaluations(status);
CREATE UNIQUE INDEX idx_task_id ON evaluations(task_id);
```

#### 数据库表关系

```mermaid
erDiagram
    users ||--o{ ai_models : "创建"
    users ||--o{ evaluations : "执行"

    users {
        int id PK
        string(50) username
        string(255) password
        string(255) email
        boolean is_active
        boolean is_admin
        datetime created_at
        datetime updated_at
    }

    ai_models {
        int id PK
        string(255) name
        string(100) provider
        string(50) model_type
        string(50) version
        json configuration
        boolean is_public
        int user_id FK
        datetime created_at
        datetime updated_at
    }

    evaluations {
        int id PK
        string(255) task_id
        string(255) model_name
        string(255) dataset_name
        string(50) status
        json results
        datetime created_at
        datetime updated_at
    }
```


## 4. 通信协议规范

### 4.1 REST API 接口规范

#### 4.1.1 接口基础定义
| 基础路径       | 内容类型         | 认证方式       |
|---------------|------------------|---------------|
| `/api/v1`     | `application/json` | Bearer Token |

#### 4.1.2 任务管理接口

##### 创建评估任务
```http
POST /api/v1/evaluations
Content-Type: application/json
Authorization: Bearer <token>

{
  "model_name": "gpt-3.5-turbo",
  "dataset_name": "mmlu",
  "model_configuration": {
    "api_key": "sk-xxxxxx",
    "api_base": "https://api.openai.com/v1"
  },
  "dataset_configuration": {
    "subset": "mathematics"
  },
  "eval_config": {
    "max_samples": 100
  }
}
```

**响应：**
```json
{
  "id": 123,
  "model_name": "gpt-3.5-turbo",
  "dataset_name": "mmlu",
  "status": "QUEUED",
  "created_at": "2024-03-15T09:00:00Z",
  "updated_at": "2024-03-15T09:00:00Z",
  "task_id": "78a7ab92-81c2-4e30-bf0d-a4c7c952b7e7"
}
```

##### 获取任务状态
```http
GET /api/v1/evaluations/{eval_id}
```

**响应：**
```json
{
  "id": 123,
  "status": "RUNNING",
  "progress": 0.65,
  "model_name": "gpt-3.5-turbo",
  "dataset_name": "mmlu",
  "results": {
    "accuracy": 0.82,
    "latency": 350
  },
  "created_at": "2024-03-15T09:00:00Z",
  "updated_at": "2024-03-15T09:05:00Z",
  "task_id": "78a7ab92-81c2-4e30-bf0d-a4c7c952b7e7"
}
```

##### 终止任务
```http
POST /api/v1/evaluations/{eval_id}/terminate
```

**成功响应：**
```json
{
  "success": true,
  "message": "任务终止请求已接受"
}
```

##### 任务列表查询
```http
GET /api/v1/evaluations?task_status=RUNNING&limit=100&offset=0
```

**响应：**
```json
{
  "items": [
    {
      "id": 123,
      "model_name": "gpt-3.5-turbo",
      "dataset_name": "mmlu",
      "status": "RUNNING",
      "created_at": "2024-03-15T09:00:00Z"
    }
  ],
  "total": 1,
  "limit": 100,
  "offset": 0
}
```

##### 获取任务日志
```http
GET /api/v1/evaluations/{eval_id}/logs?lines=50
```

**响应：**
```json
[
  "2024-03-15T09:00:00Z [INFO] 开始执行模型推理",
  "2024-03-15T09:01:00Z [INFO] 已完成50%样本评估"
]
```

##### 更新任务名称
```http
PUT /api/v1/evaluations/{eval_id}/name
Content-Type: application/json

{
  "name": "新任务名称"
}
```

##### 删除任务
```http
DELETE /api/v1/evaluations/{eval_id}
```

### 4.2 WebSocket 通信协议

#### 实时日志推送
```http
WS /api/v1/evaluations/{eval_id}/ws_logs
```

**消息类型：**
| 类型       | 说明                      | 示例                          |
|-----------|--------------------------|------------------------------|
| status    | 任务状态更新              | `{"type":"status","data":{"status":"RUNNING"}}` |
| log       | 实时日志消息              | `2024-03-15T09:00:00Z [INFO] 任务开始` |
| info      | 系统通知信息              | `{"type":"info","data":"已连接日志服务"}` |
| warning   | 警告信息                  | `{"type":"warning","data":"网络延迟较高"}` |
| error     | 错误信息                  | `{"type":"error","data":"模型加载失败"}` |
| heartbeat | 心跳包（30秒间隔）        | `{"type":"heartbeat"}` |

### 4.3 错误码规范
| 状态码 | 说明                  | 典型场景                      |
|--------|----------------------|-----------------------------|
| 400    | 请求参数错误          | 缺少必要参数/参数格式错误       |
| 401    | 未授权访问            | 缺少或无效的Token             |
| 404    | 资源不存在            | 任务ID不存在                 |
| 409    | 状态冲突              | 尝试终止已完成的任务           |
| 500    | 服务器内部错误        | 数据库连接失败                |

### 4.4 认证协议
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "your_password"
}
```

**成功响应：**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user_id": 1,
  "username": "admin",
  "is_admin": true
}
```


## 5. 工程目录结构
```
ai-eval-system/                 # 项目根目录
├── apps/
│   ├── server/                 # 后端服务
│   │   ├── src/               # 后端源代码
│   │   │   ├── core/
│   │   │   ├── infrastructure/
│   │   │   ├── services/
│   │   │   ├── api/
│   │   │   ├── config/
│   │   │   ├── utils/
│   │   │   └── entrypoints/
│   │   ├── tests/
│   │   ├── scripts/
│   │   ├── Dockerfile
│   │   ├── requirements.txt
│   │   └── alembic.ini
│   │
│   └── web/                   # 前端项目
│       ├── public/
│       ├── src/
│       └── package.json
│
├── libs/                      # 第三方库
│   └── OpenCompass/           # 软链接到实际位置
│       ├── configs/
│       ├── tools/
│       └── ... 
│
├── .env
├── .env.example
└── README.md
```

## 6. 代码实现概览






